# Data Model: Rewrite Questionnaire Agent using Microsoft Agent Framework

**Date**: 2025-10-09  
**Purpose**: Define core entities, relationships, and data structures for the multi-agent questionnaire system

## Core Entities

### Question
**Purpose**: Represents a user-submitted question requiring research and validation

**Attributes**:
- `text: str` - The natural language question content
- `context: str` - Topic or domain context (default: "Microsoft Azure AI")  
- `char_limit: int` - Maximum character limit for generated answer (default: 2000)
- `max_retries: int` - Maximum retry attempts for answer generation (default: 10)
- `id: Optional[str]` - Unique identifier for tracking (Excel processing)

**Validation Rules**:
- `text` must be non-empty and contain at least 5 characters
- `char_limit` must be between 100 and 10000 characters
- `max_retries` must be between 1 and 25 attempts
- `context` defaults to "Microsoft Azure AI" if not provided

### Answer
**Purpose**: Generated response that has passed multi-agent validation

**Attributes**:
- `content: str` - The validated answer text
- `sources: List[str]` - URLs extracted from the original response
- `agent_reasoning: List[AgentStep]` - Workflow execution history
- `char_count: int` - Actual character count of final answer
- `validation_status: ValidationStatus` - Overall validation result
- `retry_count: int` - Number of attempts required to generate

**Relationships**:
- One-to-one with Question
- One-to-many with AgentStep (reasoning history)
- One-to-many with DocumentationLink

**State Transitions**:
```
GENERATING → VALIDATING → APPROVED | REJECTED
           ↗ (retry) ←─────────────┘
```

### AgentStep
**Purpose**: Individual agent execution record in the workflow

**Attributes**:
- `agent_name: AgentType` - Which agent executed (QUESTION_ANSWERER, ANSWER_CHECKER, LINK_CHECKER)
- `input_data: str` - Input provided to the agent
- `output_data: str` - Response generated by the agent
- `execution_time: float` - Time taken in seconds
- `status: StepStatus` - SUCCESS, FAILURE, TIMEOUT
- `error_message: Optional[str]` - Error details if failed
- `timestamp: datetime` - When the step was executed

**Validation Rules**:
- `agent_name` must be valid AgentType enum value
- `execution_time` must be positive number
- `error_message` required when status is FAILURE
- `timestamp` automatically set on creation

### DocumentationLink
**Purpose**: Verified URL supporting the answer content

**Attributes**:
- `url: str` - The complete URL
- `title: Optional[str]` - Page title if retrievable
- `is_reachable: bool` - HTTP connectivity check result
- `is_relevant: bool` - Content relevance validation result
- `http_status: Optional[int]` - HTTP response code
- `validation_error: Optional[str]` - Error details if validation failed

**Validation Rules**:
- `url` must be valid HTTP/HTTPS format
- `is_reachable` and `is_relevant` both must be True for link inclusion
- `http_status` should be 2xx for reachable links
- `validation_error` provides specific failure reason

### ExcelWorkbook
**Purpose**: Represents loaded Excel file with identified columns

**Attributes**:
- `file_path: str` - Original file location
- `sheets: List[ExcelSheet]` - Individual worksheet data
- `column_mapping: ColumnMapping` - Identified question/answer columns
- `total_questions: int` - Count of questions across all sheets
- `processing_status: ProcessingStatus` - PENDING, IN_PROGRESS, COMPLETED, FAILED

**Relationships**:
- One-to-many with ExcelSheet
- One-to-one with ColumnMapping

### ExcelSheet
**Purpose**: Individual worksheet within an Excel workbook

**Attributes**:
- `name: str` - Worksheet name
- `question_column: Optional[str]` - Identified question column (e.g., "A", "B")
- `answer_column: Optional[str]` - Target answer column
- `documentation_column: Optional[str]` - Target documentation column
- `rows: List[ExcelRow]` - Row data with question/answer pairs
- `has_headers: bool` - Whether first row contains headers

**Validation Rules**:
- At least one of question_column or answer_column must be identified
- Column references must be valid Excel column format (A-Z, AA-ZZ, etc.)
- `rows` must contain at least one data row beyond headers

### ProcessingResult
**Purpose**: Outcome of single question or Excel batch processing

**Attributes**:
- `success: bool` - Overall success status
- `answers: List[Answer]` - Generated answers (can be multiple for Excel)
- `error_message: Optional[str]` - Error details if failed
- `processing_time: float` - Total time taken in seconds
- `questions_processed: int` - Count of successfully processed questions
- `questions_failed: int` - Count of failed questions

**Validation Rules**:
- `success` is True only if `questions_failed` is 0
- `error_message` required when `success` is False
- `processing_time` must be positive number
- `questions_processed + questions_failed` should equal total input questions

## Enumerations

### AgentType
```python
class AgentType(Enum):
    QUESTION_ANSWERER = "question_answerer"
    ANSWER_CHECKER = "answer_checker" 
    LINK_CHECKER = "link_checker"
```

### ValidationStatus
```python
class ValidationStatus(Enum):
    PENDING = "pending"
    APPROVED = "approved"
    REJECTED_CONTENT = "rejected_content"
    REJECTED_LINKS = "rejected_links"
    FAILED_TIMEOUT = "failed_timeout"
```

### StepStatus
```python
class StepStatus(Enum):
    SUCCESS = "success"
    FAILURE = "failure"
    TIMEOUT = "timeout"
```

### ProcessingStatus
```python
class ProcessingStatus(Enum):
    PENDING = "pending"
    IN_PROGRESS = "in_progress"
    COMPLETED = "completed"
    FAILED = "failed"
```

## Data Flow

```
Question → AgentWorkflow → Answer
    ↓           ↓             ↓
ExcelSheet → Processing → ProcessingResult
```

1. **Input Phase**: Question or ExcelWorkbook loaded and validated
2. **Processing Phase**: Microsoft Agent Framework workflow execution with AgentStep tracking
3. **Validation Phase**: Answer and DocumentationLink validation
4. **Output Phase**: ProcessingResult with Answer(s) or error details

## Persistence

**Configuration**: 
- Environment variables in .env files (never committed)
- User preferences in local application settings

**Temporary Data**:
- Excel processing creates temporary copies with results
- Agent conversation history maintained in memory during processing
- No permanent storage of questions, answers, or user data

**Cleanup Requirements**:
- Temporary Excel files deleted after processing complete
- Azure AI agent sessions cleaned up via FoundryAgentSession
- Memory-based data structures garbage collected after processing